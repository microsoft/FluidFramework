/*!
 * Copyright (c) Microsoft Corporation and contributors. All rights reserved.
 * Licensed under the MIT License.
 */

import type {
	ContainerExtension,
	ContainerExtensionFactory,
	InboundExtensionMessage,
} from "@fluidframework/container-runtime-definitions/internal";
import { assert } from "@fluidframework/core-utils/internal";
import type { IFluidContainer } from "@fluidframework/fluid-static";
import { isInternalFluidContainer } from "@fluidframework/fluid-static/internal";

import type { ExtensionHost, ExtensionRuntimeProperties } from "./internalTypes.js";
import type { Presence, PresenceWithNotifications } from "./presence.js";
import type { PresenceExtensionInterface } from "./presenceManager.js";
import { createPresenceManager } from "./presenceManager.js";
import type { SignalMessages } from "./protocol.js";

/**
 * Common Presence manager for a container
 */
class ContainerPresenceManager
	implements
		ContainerExtension<ExtensionRuntimeProperties>,
		InstanceType<
			ContainerExtensionFactory<PresenceWithNotifications, ExtensionRuntimeProperties>
		>
{
	// ContainerExtensionFactory return elements
	public readonly interface: PresenceWithNotifications;
	public readonly extension = this;

	private readonly manager: PresenceExtensionInterface;

	public constructor(host: ExtensionHost) {
		this.interface = this.manager = createPresenceManager({
			...host,
			submitSignal: (message) => {
				host.submitAddressedSignal([], message);
			},
		});
	}

	public onNewUse(): void {
		// No-op
	}

	public static readonly extensionId = "dis:bb89f4c0-80fd-4f0c-8469-4f2848ee7f4a";

	public processSignal(
		addressChain: string[],
		message: InboundExtensionMessage<SignalMessages>,
		local: boolean,
	): void {
		this.manager.processSignal(addressChain, message, local);
	}
}

/**
 * Acquire a {@link Presence} from a Fluid Container
 * @param fluidContainer - Fluid Container to acquire the map from
 * @returns the {@link Presence}
 *
 * @beta
 */
export const getPresence: (fluidContainer: IFluidContainer) => Presence = getPresenceAlpha;

/**
 * Acquire a {@link PresenceWithNotifications} from a Fluid Container
 * @param fluidContainer - Fluid Container to acquire the map from
 * @returns the {@link PresenceWithNotifications}
 *
 * @alpha
 */
export function getPresenceAlpha(fluidContainer: IFluidContainer): PresenceWithNotifications {
	assert(
		isInternalFluidContainer(fluidContainer),
		0xa2f /* IFluidContainer was not recognized. Only Containers generated by the Fluid Framework are supported. */,
	);

	const presence = fluidContainer.acquireExtension(
		ContainerPresenceManager.extensionId,
		ContainerPresenceManager,
	);
	return presence;
}
