{"version":3,"file":"videoPlayers.js","sourceRoot":"","sources":["../src/videoPlayers.ts"],"names":[],"mappings":"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","sourcesContent":["/*!\n * Copyright (c) Microsoft Corporation. All rights reserved.\n * Licensed under the MIT License.\n */\n\nimport {\n    IFluidObject,\n    IFluidHandleContext,\n    IFluidLoadable,\n    IFluidRouter,\n    IRequest,\n    IResponse,\n} from \"@fluidframework/core-interfaces\";\nimport { FluidObjectHandle } from \"@fluidframework/datastore\";\nimport * as ClientUI from \"@fluid-example/client-ui-lib\";\nimport { IFluidObjectCollection } from \"@fluid-example/fluid-object-interfaces\";\nimport { SharedDirectory, ISharedDirectory } from \"@fluidframework/map\";\nimport { IFluidDataStoreContext, IFluidDataStoreFactory } from \"@fluidframework/runtime-definitions\";\nimport { LazyLoadedDataObject, LazyLoadedDataObjectFactory } from \"@fluidframework/data-object-base\";\nimport { IFluidHTMLView } from \"@fluidframework/view-interfaces\";\n\ndeclare global {\n    interface Window {\n        onYouTubeIframeAPIReady?: () => void;\n        YT: any;\n    }\n}\n\nclass YouTubeAPI {\n    private static singletonP: Promise<YouTubeAPI>;\n\n    public static async GetOrCreate(): Promise<YouTubeAPI> {\n        // eslint-disable-next-line @typescript-eslint/no-misused-promises\n        if (!YouTubeAPI.singletonP) {\n            YouTubeAPI.singletonP = YouTubeAPI.Create();\n        }\n\n        return YouTubeAPI.singletonP;\n    }\n\n    private static async Create(): Promise<YouTubeAPI> {\n        const playerApiReadyP = new Promise<void>((resolve) => {\n            window.onYouTubeIframeAPIReady = resolve;\n        });\n\n        // Load in Youtube Script\n        const script = document.createElement(\"script\");\n        script.src = \"https://www.youtube.com/iframe_api\";\n        document.head.appendChild(script);\n\n        await playerApiReadyP;\n\n        return new YouTubeAPI();\n    }\n\n    private constructor() {\n    }\n\n    public createPlayer(element: HTMLDivElement, width: number, height: number, videoId: string): IYouTubePlayer {\n        const player = new window.YT.Player(\n            element,\n            {\n                height,\n                videoId,\n                width,\n            });\n\n        // eslint-disable-next-line @typescript-eslint/no-unsafe-return\n        return player;\n    }\n}\n\ninterface IYouTubePlayer {\n    setSize(width: number, height: number);\n}\n\nexport class VideoPlayer implements\n    IFluidLoadable, IFluidHTMLView, IFluidRouter, ClientUI.controls.IViewLayout {\n    private player: IYouTubePlayer;\n    private playerDiv: HTMLDivElement;\n\n    public get IFluidHTMLView() { return this; }\n    public get IFluidRouter() { return this; }\n    public get IViewLayout() { return this; }\n    public get IFluidLoadable() { return this; }\n\n    // Video def has a preferred aspect ratio\n    public aspectRatio?: number;\n    public minimumWidth?: number;\n    public minimumHeight?: number;\n    public readonly canInline = true;\n    public readonly preferInline = false;\n    public readonly preferPersistentElement = true;\n    public handle: FluidObjectHandle;\n\n    constructor(\n        public videoId: string,\n        context: IFluidHandleContext,\n        private readonly keyId: string,\n        private readonly youTubeApi: YouTubeAPI,\n        private readonly collection: VideoPlayerCollection,\n    ) {\n        this.handle = new FluidObjectHandle(this, keyId, context);\n    }\n\n    public heightInLines() {\n        // Component will want to describe its height in pixels\n        // Right now we're assuming it's 22px per line\n        // 18 is simply an arbitrary number and was chosen to differ from the pinpoint map's choice of 24\n        return 18;\n    }\n\n    public render(elm: HTMLElement): void {\n        const size = elm.getBoundingClientRect();\n\n        if (!this.player) {\n            this.playerDiv = document.createElement(\"div\");\n            const youTubeDiv = document.createElement(\"div\");\n            this.playerDiv.appendChild(youTubeDiv);\n            elm.appendChild(this.playerDiv);\n\n            this.player = this.youTubeApi.createPlayer(\n                youTubeDiv,\n                size.width,\n                size.height,\n                this.videoId);\n        } else {\n            if (elm !== this.playerDiv.parentElement) {\n                this.playerDiv.remove();\n                elm.appendChild(this.playerDiv);\n            }\n\n            this.player.setSize(size.width, size.height);\n        }\n    }\n\n    public changeValue(newValue: number) {\n        this.collection.changeValue(this.keyId, newValue);\n    }\n\n    public async request(request: IRequest): Promise<IResponse> {\n        return {\n            mimeType: \"fluid/object\",\n            status: 200,\n            value: this,\n        };\n    }\n}\n\nexport class VideoPlayerCollection extends LazyLoadedDataObject<ISharedDirectory> implements\n    IFluidObjectCollection {\n    private static readonly factory = new LazyLoadedDataObjectFactory<VideoPlayerCollection>(\n        \"@fluid-example/video-players\",\n        VideoPlayerCollection,\n        SharedDirectory.getFactory(),\n    );\n\n    public static getFactory(): IFluidDataStoreFactory { return VideoPlayerCollection.factory; }\n\n    public static async create(parentContext: IFluidDataStoreContext, props?: any) {\n        return VideoPlayerCollection.factory.create(parentContext, props);\n    }\n\n    // TODO: either better error handling is needed here, or create() should be async\n    public create() { this.initialize().catch((error) => { console.error(error); }); }\n    public async load() { await this.initialize(); }\n\n    public get IFluidRouter() { return this; }\n    public get IFluidLoadable() { return this; }\n    public get IFluidObjectCollection() { return this; }\n\n    private readonly videoPlayers = new Map<string, VideoPlayer>();\n\n    public changeValue(key: string, newValue: number) {\n        this.root.set(key, newValue);\n    }\n\n    public createCollectionItem(): VideoPlayer {\n        const id = `video-${Date.now()}`;\n        this.root.set(id, \"RMzXmkrlFNg\");\n        // Relying on valueChanged event to create the bar is error prone\n        return this.videoPlayers.get(id);\n    }\n\n    public removeCollectionItem(instance: IFluidObject): void {\n        throw new Error(\"Method not implemented.\");\n    }\n\n    public getProgress(): string[] {\n        return Array.from(this.root.keys()).map((key) => `/${key}`);\n    }\n\n    public async request(request: IRequest): Promise<IResponse> {\n        // TODO the request is not stripping / off the URL\n        const trimmed = request.url\n            .substr(1)\n            .substr(0, !request.url.includes(\"/\", 1) ? request.url.length : request.url.indexOf(\"/\"));\n\n        if (!trimmed) {\n            return {\n                mimeType: \"fluid/object\",\n                status: 200,\n                value: this,\n            };\n        }\n\n        // TODO we need a way to return an observable for a request route (if asked for) to notice updates\n        // or at least to request a value >= a sequence number\n        await this.root.wait(trimmed);\n\n        return this.videoPlayers.get(trimmed).request({ url: trimmed.substr(1 + trimmed.length) });\n    }\n\n    private async initialize() {\n        // TODO for simplicity initializing youtube api now but it's probably not always the case we will want to do\n        // this - especially since we may just be loading the model data here\n        const youTubeApi = await YouTubeAPI.GetOrCreate();\n\n        for (const key of this.root.keys()) {\n            this.videoPlayers.set(\n                key,\n                new VideoPlayer(\n                    this.root.get(key),\n                    this.runtime.objectsRoutingContext,\n                    key,\n                    youTubeApi,\n                    this));\n        }\n\n        this.root.on(\"valueChanged\", (changed) => {\n            if (this.videoPlayers.has(changed.key)) {\n                // TODO add support for video playback values\n                // this.videoPlayers.get(changed.key).update(this.root.get(changed.key));\n            } else {\n                const player = new VideoPlayer(\n                    this.root.get(changed.key),\n                    this.runtime.objectsRoutingContext,\n                    changed.key,\n                    youTubeApi,\n                    this);\n                this.videoPlayers.set(changed.key, player);\n            }\n        });\n    }\n}\n\nexport const fluidExport: IFluidDataStoreFactory = VideoPlayerCollection.getFactory();\n"]}