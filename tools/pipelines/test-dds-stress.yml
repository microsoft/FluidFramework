# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# "Test - DDS Stress" pipeline

name: $(Build.BuildId)

trigger: none
pr: none

resources:
  pipelines:
  - pipeline: client   # Name of the pipeline resource
    source: Build - client packages
    trigger:
      branches:
      - release/*
      - main
      - next
      paths: # Only bother running the pipeline at all if any of the relevant packages have changed.
      - packages/dds/sequence/*
      - packages/dds/merge-tree/*
      - experimental/dds/tree/*

variables:
- name: testWorkspace
  value: $(Pipeline.Workspace)/test

stages:
  - stage:
    displayName:  Stress tests - SharedString
    dependsOn: []
    jobs:
    - template: templates/include-test-real-service.yml
      parameters:
        poolBuild: Small
        extraDependencies: mocha @fluid-internal/stochastic-test-utils
        testPackage: "@fluidframework/sequence"
        testWorkspace: ${{ variables.testWorkspace }}
        timeoutInMinutes: 120
        testFileTarName: sequence
        testCommand: test:mocha
        env:
          FUZZ_TEST_COUNT: 10
          FUZZ_STRESS_RUN: true

  - stage:
    displayName:  Stress tests - Legacy SharedTree
    dependsOn: []
    jobs:
    - template: templates/include-test-real-service.yml
      parameters:
        poolBuild: Small
        extraDependencies: mocha @fluid-internal/stochastic-test-utils
        testPackage: "@fluid-experimental/tree"
        testWorkspace: ${{ variables.testWorkspace }}
        testFileTarName: experimental-tree
        timeoutInMinutes: 120
        testCommand: test:mocha
        env:
          FUZZ_TEST_COUNT: 5
          FUZZ_STRESS_RUN: true
