# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-publish-npm-package

parameters:
- name: namespace
  type: boolean

- name: tagName
  type: string

- name: publishNonScopedPackages
  type: boolean
  default: false

stages:
- stage: publish_npm_internal_test
  dependsOn: build
  displayName: Publish Internal Test Packages
  condition: and(succeeded(), eq(variables['testBuild'], true))
  jobs:
  - template: include-publish-npm-package-steps.yml
    parameters:
      namespace: ${{ parameters.namespace }}
      feedName: https://pkgs.dev.azure.com/fluidframework/internal/_packaging/test/npm/registry/
      environment: test-package-build-feed
      official: false
      artifactPath: scoped
  - ${{ if eq(parameters.publishNonScopedPackages, true) }}:  
    - template: include-publish-npm-package-steps.yml
      parameters:
        namespace: false
        feedName: https://pkgs.dev.azure.com/fluidframework/internal/_packaging/test/npm/registry/
        environment: test-package-build-feed
        official: false
        artifactPath: non-scoped

- stage: publish_npm_internal
  dependsOn: build
  displayName: Publish Internal Packages
  condition: and(succeeded(), eq(variables['testBuild'], false))
  jobs:
  - template: include-publish-npm-package-steps.yml
    parameters:
      namespace: ${{ parameters.namespace }}
      feedName: https://pkgs.dev.azure.com/fluidframework/internal/_packaging/build/npm/registry/
      environment: package-build-feed
      official: false
      artifactPath: scoped
  - ${{ if eq(parameters.publishNonScopedPackages, true) }}:  
    - template: include-publish-npm-package-steps.yml
      parameters:
        namespace: false
        feedName: https://pkgs.dev.azure.com/fluidframework/internal/_packaging/build/npm/registry/
        environment: package-build-feed
        official: false
        artifactPath: non-scoped

- stage: publish_npm_official
  dependsOn: build
  displayName: Publish Official Packages
  condition: and(succeeded(), or(eq(variables['release'], 'release'), eq(variables['release'], 'prerelease')))
  jobs:
  - template: include-publish-npm-package-steps.yml
    parameters:
      namespace: ${{ parameters.namespace }}
      feedName: https://registry.npmjs.org
      environment: package-npmjs-feed
      customEndPoint: npmjs
      official: true
      publishFlags: --access public
      tagName: ${{ parameters.tagName }}
      artifactPath: scoped
  - ${{ if eq(parameters.publishNonScopedPackages, true) }}:  
    - template: include-publish-npm-package-steps.yml
      parameters:
        namespace: false
        feedName: https://registry.npmjs.org
        environment: package-npmjs-feed
        customEndPoint: npmjs
        official: true
        publishFlags: --access public
        tagName: ${{ parameters.tagName }}
        artifactPath: non-scoped
