# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-publish-npm-package

parameters:
- name: tagName
  type: string

- name: pool
  type: object
  default: Small-eastus2

stages:
- stage: publish_npm_internal_test
  dependsOn: build
  displayName: Publish Internal Test Packages
  condition: and(succeeded(), eq(variables['testBuild'], true))
  jobs:
  - template: /tools/pipelines/templates/include-publish-npm-package-deployment.yml@self
    parameters:
      feedKind: internal-test
      feedUrl: $(ado-feeds-test)
      environment: test-package-build-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      packageManager: pnpm

- stage: publish_npm_internal
  dependsOn: build
  displayName: Publish Internal Packages
  condition: and(succeeded(), eq(variables['testBuild'], false))
  jobs:
  - template: /tools/pipelines/templates/include-publish-npm-package-deployment.yml@self
    parameters:
      feedUrl: $(ado-feeds-build)
      feedKind: internal-build
      environment: package-build-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      packageManager: pnpm

- stage: publish_npm_official
  dependsOn: build
  displayName: Publish Official Packages
  condition: and(succeeded(), or(eq(variables['release'], 'release'), eq(variables['release'], 'prerelease')))
  jobs:
  - template: /tools/pipelines/templates/include-publish-npm-package-deployment.yml@self
    parameters:
      feedKind: public
      feedUrl: https://registry.npmjs.org
      environment: package-npmjs-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      customEndPoint: npmjs
      tagName: ${{ parameters.tagName }}
      packageManager: pnpm
