# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-publish-npm-package

parameters:
- name: tagName
  type: string

- name: pool
  type: object
  default: Small-eastus2

- name: testBuild
  type: boolean

- name: release
  type: string

stages:
- stage: publish_npm_internal_test
  dependsOn: build
  displayName: Publish Internal Test Packages
  condition: and(succeeded(), eq(${{ parameters.testBuild }}, true))
  jobs:
  - template: include-publish-npm-package-deployment.yml
    parameters:
      feedKind: internal-test
      feedUrl: $(ado-feeds-test)
      environment: test-package-build-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      packageManager: pnpm
      release: ${{ parameters.release }}

- stage: publish_npm_internal
  dependsOn: build
  displayName: Publish Internal Packages
  condition: and(succeeded(), eq(${{ parameters.testBuild }}, false))
  jobs:
  - template: include-publish-npm-package-deployment.yml
    parameters:
      feedUrl: $(ado-feeds-build)
      feedKind: internal-build
      environment: package-build-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      packageManager: pnpm
      release: ${{ parameters.release }}

- stage: publish_npm_official
  dependsOn: build
  displayName: Publish Official Packages
  condition: and(succeeded(), or(eq('${{ parameters.release }}', 'release'), eq('${{ parameters.release }}', 'prerelease')))
  jobs:
  - template: include-publish-npm-package-deployment.yml
    parameters:
      feedKind: public
      feedUrl: https://registry.npmjs.org
      environment: package-npmjs-feed
      pool: ${{ parameters.pool }}
      packageManagerInstallCommand: 'pnpm i --frozen-lockfile'
      customEndPoint: npmjs
      tagName: ${{ parameters.tagName }}
      packageManager: pnpm
      release: ${{ parameters.release }}
