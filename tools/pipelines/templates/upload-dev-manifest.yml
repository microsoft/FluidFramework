# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

parameters:  
- name: buildDirectory
  type: string
  
- name: STORAGE_ACCOUNT
  type: string

- name: STORAGE_KEY
  type: string

steps:
- task: Bash@3
  displayName: Generate release reports
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.buildDirectory }}
    script: |
      mkdir generate_manifest_files
      flub release report -g client -o generate_manifest_files

- task: Bash@3
  displayName: Update release report version
  env:
    VERSION: $(SetVersion.version)
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.buildDirectory }}
    script: |
      mkdir upload_manifest_files
      flub release report-unreleased -c generate_manifest_files -s generate_manifest_files --outDir upload_manifest_files

- task: AzureCLI@2
  displayName: Upload release reports
  continueOnError: true
  inputs:
    azureSubscription: 'fluid-docs'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      for file in upload_manifest_files/*; do
          az storage blob upload -f "$file" -c 'manifest-files' -n "$(basename "$file")" --account-name ${{ parameters.STORAGE_ACCOUNT }} --account-key ${{ parameters.STORAGE_KEY }} --overwrite true --verbose
      done

- task: Bash@3
  displayName: Delete manifest files from root
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.buildDirectory }}
    script: |
      # Delete generate_manifest_files and upload_manifest_files folder
      rm -r generate_manifest_files upload_manifest_files
