# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

parameters:
- name: buildDirectory
  type: string

jobs:
  - job:
    displayName: Upload Release Reports
    variables:
    - group: storage-vars
    - name: version
      value: $[stageDependencies.build.build.outputs['SetVersion.version']]
    steps:
    - checkout: self
      path: $(FluidFrameworkDirectory)
    - template: /tools/pipelines/templates/include-use-node-version.yml@self
    - template: /tools/pipelines/templates/include-install-build-tools.yml@self
      parameters:
        buildDirectory: ${{ parameters.buildDirectory }}

    - task: Bash@3
      displayName: Generate release reports
      inputs:
        targetType: 'inline'
        workingDirectory: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
        script: |
          set -eu -o pipefail
          mkdir generate_release_reports
          flub release report -g client -o generate_release_reports --baseFileName manifest

    - task: Bash@3
      displayName: Update release report version
      inputs:
        targetType: 'inline'
        workingDirectory: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
        script: |
          set -eu -o pipefail
          mkdir upload_release_reports
          flub release report-unreleased --version $(version) --fullReportFilePath generate_release_reports/manifest.full.json --outDir upload_release_reports --branchName '$(Build.SourceBranch)'

    - task: CopyFiles@2
      displayName: Copy release reports
      inputs:
        SourceFolder: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}/upload_release_reports
        TargetFolder: $(Build.ArtifactStagingDirectory)/release_reports

    - template: /tools/pipelines/templates/include-upload-blob-storage.yml@self
      parameters:
        serviceConnection: 'fluid-docs'
        storageAccount: $(STORAGE_ACCOUNT)
        containerName: 'manifest-files'
        sourcePattern: 'upload_release_reports/*'
        displayName: 'Upload release reports to old storage'
        workingDirectory: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
        contentCache: 'max-age=300'

    - template: /tools/pipelines/templates/include-upload-blob-storage.yml@self
      parameters:
        serviceConnection: 'fluid-docs-torus'
        storageAccount: $(STORAGE_ACCOUNT_NEW)
        containerName: 'manifest-files'
        sourcePattern: 'upload_release_reports/*'
        displayName: 'Upload release reports to new storage'
        workingDirectory: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
        contentCache: 'max-age=300'

    - task: Bash@3
      displayName: Clean up temporary directories
      inputs:
        targetType: 'inline'
        workingDirectory: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
        script: |
          # Delete generate_release_reports and upload_release_reports folder
          rm -r generate_release_reports upload_release_reports

    - task: 1ES.PublishPipelineArtifact@1
      displayName: Publish Artifact - release_reports
      inputs:
        targetPath: $(Build.ArtifactStagingDirectory)/release_reports
        artifactName: release_reports
        publishLocation: pipeline
