# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

parameters:
- name: loggerPackage
  type: string
  default: '@ff-internal/aria-logger'

- name: pathToTelemetryGenerator
  type: string
  default: '$(Build.SourcesDirectory)/tools/telemetry-generator'

- name: devFeedUrl
  type: string

- name: officeFeedUrl
  type: string

steps:
# Need to checkout the repo in order to run @fluid-tools/telemetry-generator which we don't publish right now.
- checkout: self
  clean: true

- template: include-use-node-version.yml

- task: Bash@3
  displayName: Print parameter/variable values for template
  inputs:
    targetType: 'inline'
    script: |
      echo "
      Parameters:
        loggerPackage=${{ parameters.loggerPackage }}
        pathToTelemetryGenerator=${{ parameters.pathToTelemetryGenerator }}
        devFeedUrl={{ parameters.devFeedUrl }}
        officeFeedUrl={{ parameters.officeFeedUrl }}
      "

- task: Bash@3
  displayName: Initialize npmrc
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.pathToTelemetryGenerator }}
    # Note: $(ado-feeds-build) and $(ado-feeds-office) come from the ado-feeds variable group
    script: |
      echo Initialize package
      npm init --yes

      echo Generating .npmrc
      echo "registry=https://registry.npmjs.org" >> ./.npmrc
      echo "always-auth=false" >> ./.npmrc

      echo "@fluidframework:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@fluid-experimental:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@fluid-tools:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@fluid-internal:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@fluid-private:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@ff-internal:registry=${{ parameters.devFeedUrl }}" >> ./.npmrc
      echo "@microsoft:registry=${{ parameters.officeFeedUrl }}" >> ./.npmrc
      echo "always-auth=true" >> ./.npmrc
      cat .npmrc

# Auth to internal feed
- task: npmAuthenticate@0
  displayName: 'npm authenticate (internal feed)'
  inputs:
    workingFile: ${{ parameters.pathToTelemetryGenerator }}/.npmrc

# Install test and logger package
- task: Npm@1
  displayName: 'npm install aria logger'
  inputs:
    workingDir: ${{ parameters.pathToTelemetryGenerator }}
    command: 'custom'
    customCommand: 'install ${{ parameters.loggerPackage }}'
    customRegistry: 'useNpmrc'

- task: Bash@3
  displayName: 'Prepare telemetry-generator'
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.pathToTelemetryGenerator }}
    script: |
      npm i;
      npm run build:compile;
