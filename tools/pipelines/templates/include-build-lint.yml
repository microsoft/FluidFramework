# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-build-lint template for the Build and Lint step in client build and test stability pipeline

parameters:
- name: taskBuild
  type: string
  default: ci:build

- name: taskLint
  type: boolean
  default: true

- name: taskLintName
  type: string
  default: lint

- name: buildDirectory
  type: string

steps:
- ${{ if ne(parameters.taskBuild, 'false') }}:
  - task: Npm@1
    displayName: npm run ${{ parameters.taskBuild }}
    env:
      # Set FLUB_TYPETEST_SKIP_VERSION_OUTPUT to 1 when building from test/* branches
      # This preserves existing version info in generated type test files
      FLUB_TYPETEST_SKIP_VERSION_OUTPUT: $(testBuild)
      # Suppress "data is over two months old" warnings from baseline-browser-mapping,
      # a transitive dependency of browserslist. Without this, the warning fires once
      # per package during builds, producing 100+ identical warnings in build logs.
      BASELINE_BROWSER_MAPPING_IGNORE_OLD_DATA: 1
      # Enable content-hash mode for fluid-build tasks that default to mtime-based
      # done file checks. This is required for incremental build caching across CI runs,
      # since git checkout resets file mtimes but content hashes remain stable.
      FLUID_BUILD_ENABLE_COPYFILES_HASH: 1
      FLUID_BUILD_ENABLE_TYPEVALIDATION_HASH: 1
      FLUID_BUILD_ENABLE_GOODFENCE_HASH: 1
      FLUID_BUILD_ENABLE_DEPCRUISE_HASH: 1
    inputs:
      command: 'custom'
      workingDir: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
      customCommand: 'run ${{ parameters.taskBuild }}'

- ${{ if ne(parameters.taskLint, false) }}:
  - task: Npm@1
    displayName: npm run ${{ parameters.taskLintName }}
    env:
      # Suppress baseline-browser-mapping staleness warnings during lint as well.
      BASELINE_BROWSER_MAPPING_IGNORE_OLD_DATA: 1
    inputs:
      command: 'custom'
      workingDir: $(Pipeline.Workspace)/${{ parameters.buildDirectory }}
      customCommand: 'run ${{ parameters.taskLintName }}'
