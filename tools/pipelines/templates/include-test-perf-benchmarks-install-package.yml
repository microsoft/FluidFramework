# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# This template is intended to be used for common steps across stages of the test-perf-benchmarks.yml pipeline.
# It downloads (from the artifacts produced by another pipeline) and installs a specified package that has performance tests.

parameters:
# Identifier for the pipeline that produced the artifact with the package to be installed.
# Will be used for the 'pipeline' input for a DownloadPipelineArtifact task.
- name: artifactPipeline
  type: string

# Identifier for the pipeline run that produced the artifact with the package to be installed.
# Will be used for the 'buildId' input for a DownloadPipelineArtifact task.
- name: artifactBuildId
  type: string

# Name of the package to be installed.
- name: testPackageName
  type: string

# Path where the package should be installed. This template assumes an appropriate .npmrc file was already setup there
# so dependencies can be resolved from our feeds.
- name: installPath
  type: string

steps:
- task: Bash@3
  displayName: Set local template variables
  # Need to give this step a unique name because this template is used several times in the same pipeline.
  # If at some point this becomes hard to do, we can switch to using standard variables (vs output variables from
  # a step) so the step doesn't need a name
  name: localVariables_${{ replace(replace(parameters.testPackageName, '@', '' ), '/', '-') }}
  inputs:
    targetType: 'inline'
    script: |
      echo "Setting local variables for yml template"
      echo "##vso[task.setvariable variable=sanitizedPackageName;isOutput=true]${{ replace(replace(parameters.testPackageName, '@', '' ), '/', '-') }}-?.?.?-*.tgz"
      echo "##vso[task.setvariable variable=downloadPath;isOutput=true]$(Pipeline.Workspace)/downloadedPackages"

# Download package that has performance tests
- task: DownloadPipelineArtifact@2
  displayName: Download package with perf tests
  inputs:
    # It seems there's a bug and preferTriggeringPipeline is not respected.
    # We force the behavior by explicitly specifying:
    # - buildVersionToDownload: specific
    # - buildId: <the id of the triggering build>
    # preferTriggeringPipeline: true
    source: specific
    project: internal
    pipeline: ${{ parameters.artifactPipeline }}
    buildVersionToDownload: specific
    buildId: ${{ parameters.artifactBuildId }}
    artifact: pack
    patterns: "**/$(localVariables.sanitizedPackageName)"
    path: $(localVariables.downloadPath)
    # allowPartiallySucceededBuilds: true # No effect as long as we have buildVersionToDownload: specific
    # branchName: $(Build.SourceBranch)   # No effect as long as we have buildVersionToDownload: specific

# Install package that has performance tests
- task: Bash@3
  displayName: Install package with perf tests
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.installPath }}
    script: |
      echo "Installing ${{ parameters.testPackageName }}"

      TEST_PACKAGE_PATH_PATTERN=$(localVariables.downloadPath)/scoped/$(localVariables.sanitizedPackageName)
      echo "Looking for tarball with pattern $TEST_PACKAGE_PATH_PATTERN :"
      ls -1 $TEST_PACKAGE_PATH_PATTERN

      if [[ `ls -1 $TEST_PACKAGE_PATH_PATTERN | wc -l` -eq 1 ]]; then
        npm install $(ls $TEST_PACKAGE_PATH_PATTERN)
      else
        echo "##vso[task.logissue type=error]Test package '${{ parameters.testPackageName }}' not found, or more than one possible match found. See messages above."
        exit -1
      fi
