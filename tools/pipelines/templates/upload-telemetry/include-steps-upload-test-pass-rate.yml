# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-steps-upload-test-pass-rate

# This template adds steps to the upload-telemetry stage to include the upload of test pass rates.
# The new stage "targets" another stage (specified as a parameter) and uploads telemetry about that stage to Kusto.

parameters:

# Id for the stage whose runtime + result telemetry will be uploaded to Kusto.
- name: stageId
  type: string

# Unique identifier for the pipeline that is including this template.
# Used to identify telemetry data in Kusto for this pipeline.
- name: pipelineIdentifierForTelemetry
  type: string

# The sources directory that was used for the test run
- name: testWorkspace
  type: string

steps:
- task: Bash@3
displayName: Get test pass rate data from ADO
env:
	BUILD_ID: $(Build.BuildId)
	STAGE_ID: ${{ parameters.stageId }}
	ADO_API_TOKEN: $(System.AccessToken)
	WORK_FOLDER: ${{ parameters.testWorkspace }}/stageTestPassRate
inputs:
	targetType: 'inline'
	script: |
	set -eu -o pipefail
	echo "Fetching test pass rate data and saving into JSON files"
	node "$(Build.SourcesDirectory)/scripts/get-test-pass-rate.mjs"

- task: Bash@3
displayName: Submit telemetry for test pass rate
env:
	BUILD_ID: $(Build.BuildId)
	STAGE_ID: ${{ parameters.stageId }}
	PIPELINE: ${{ parameters.pipelineIdentifierForTelemetry }}
	WORK_FOLDER: ${{ parameters.testWorkspace }}/stageTestPassRate
inputs:
	targetType: 'inline'
	workingDirectory: $(Build.SourcesDirectory)
	script: |
	set -eu -o pipefail
	echo "Listing files in '$WORK_FOLDER'"
	ls -laR $WORK_FOLDER;

	pnpm exec telemetry-generator --handlerModule "$(pathToTelemetryGeneratorHandlersNew)/testPassRate.js" --dir "$WORK_FOLDER"
