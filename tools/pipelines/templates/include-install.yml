# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-install template for the install step in client build and test stability pipeline

parameters:
- name: packageManager
  type: string

- name: buildDirectory
  type: string

- name: packageManagerInstallCommand
  type: string

steps:
  - ${{ if eq(parameters.packageManager, 'pnpm') }}:
    - template: include-install-pnpm.yml
      parameters:
        buildDirectory: ${{ parameters.buildDirectory }}
        enableCache: false

  - task: Bash@3
    displayName: Install dependencies
    inputs:
      targetType: 'inline'
      workingDirectory: ${{ parameters.buildDirectory }}
      script: |
        set -eu -o pipefail
        echo "registry: $(pnpm config get registry)"
        echo "Removing node_modules"
        rm -rf node_modules
        echo "Running install"
        registry="$(pnpm config get registry)"
        token=$(echo -n "Bearer ${SYSTEM_ACCESSTOKEN}" | base64)
        if [ $registry != "https://registry.npmjs.org/" ]; then
          echo "Authenticating to registry: ${registry}"
          npm config set //${registry}:_authToken=${token}
        else
          echo "No authentication needed for registry: ${registry}"
        fi
        ${{ parameters.packageManagerInstallCommand }}
    env:
      NPM_CONFIG_REGISTRY: $(ado-feeds-primary-registry)
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
