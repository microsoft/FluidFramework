# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# Installs dependencies in the specified directory. If using pnpm, also ensures pnpm is installed
# and configured in ${{ parameters.pnpmInstallDirectory }}

parameters:
- name: packageManager
  type: string

- name: buildDirectory
  type: string

- name: packageManagerInstallCommand
  type: string

- name: pnpmInstallDirectory
  type: string
  default: $(Build.SourcesDirectory)

steps:
  - ${{ if eq(parameters.packageManager, 'pnpm') }}:
    - template: include-install-pnpm.yml
      parameters:
        buildDirectory: ${{ parameters.pnpmInstallDirectory }}

  - task: Bash@3
    displayName: Install dependencies
    inputs:
      targetType: 'inline'
      workingDirectory: ${{ parameters.buildDirectory }}
      script: |
        set -eu -o pipefail
        registry="$(pnpm config get registry)"
        token=$(echo -n "${SYSTEM_ACCESSTOKEN}" | base64 --wrap 0)
        if [ $registry != "https://registry.npmjs.org/" ]; then
          echo "Authenticating to registry: ${registry}"
          # Remove leading `https://` from registry URL
          registryNoProtocol=${registry#https://}
          pnpm config set "//${registryNoProtocol}:username=ci"
          pnpm config set "//${registryNoProtocol}:_password=\"${token}\""
        else
          echo "No authentication needed for registry: ${registry}"
        fi
        echo "Installing dependencies."
        ${{ parameters.packageManagerInstallCommand }}
    env:
      NPM_CONFIG_REGISTRY: $(ado-feeds-primary-registry)
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)
