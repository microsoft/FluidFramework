# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-install-build-tools
#
# This template can be included in pipelines to install the Fluid build-tools locally so flub can be used in the
# pipeline.

parameters:
- name: buildDirectory
  type: string

- name: buildToolsVersionToInstall
  type: string
  default: repo

# The path to the pnpm store.
- name: pnpmStorePath
  type: string
  default: $(Pipeline.Workspace)/.pnpm-store

steps:
- ${{ if eq(parameters.buildToolsVersionToInstall, 'repo') }}:
  - task: Bash@3
    name: PrependPath
    displayName: Prepend build-tools CLI to path
    inputs:
      targetType: 'inline'
      workingDirectory: ${{ parameters.buildDirectory }}
      script: |
        # Prepend the cli bin dir to the path. See
        # <https://docs.microsoft.com/en-us/azure/devops/pipelines/scripts/logging-commands?view=azure-devops&tabs=bash#prependpath-prepend-a-path-to-the--path-environment-variable>
        # more information.
        echo "##vso[task.prependpath]$(Build.SourcesDirectory)/build-tools/packages/build-cli/bin"

  - template: include-install-pnpm.yml
    parameters:
      buildDirectory: $(Build.SourcesDirectory)/build-tools
      pnpmStorePath: ${{ parameters.pnpmStorePath }}
      enableCache: false

  - task: Bash@3
    name: InstallBuildTools
    displayName: Install Fluid Build Tools (from repo)
    inputs:
      targetType: 'inline'
      workingDirectory: $(Build.SourcesDirectory)/build-tools
      script: |
        pnpm i --frozen-lockfile
        pnpm build:compile

- ${{ if ne(parameters.buildToolsVersionToInstall, 'repo') }}:
  - task: Bash@3
    name: InstallBuildTools
    displayName: Install Fluid Build Tools (from npm)
    inputs:
      targetType: 'inline'
      workingDirectory: ${{ parameters.buildDirectory }}
      script: |
        echo "${{ parameters.buildToolsVersionToInstall }}"
        npm install --global "@fluid-tools/build-cli@${{ parameters.buildToolsVersionToInstall }}"

- task: Bash@3
  name: BuildToolsInstallCheck
  displayName: Check Build Tools Installation
  inputs:
    targetType: 'inline'
    workingDirectory: ${{ parameters.buildDirectory }}
    script: |
      # Output the help and full command list for debugging purposes
      which flub
      flub --help
      flub commands
