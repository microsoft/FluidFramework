# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

parameters:
- name: buildDirectory
  type: string

# A list of directories (under the buildDirectory) to run the PublishTestResults task on in separate steps.
# Used to avoid the force merge limit of 100 result files.
- name: testResultDirs
  type: object
  default:
  - nyc

steps:
  # Test - Verify and Publish results
  - ${{ each testResultDir in parameters.testResultDirs }}:
    # Check if the directory contains test result files
    - script: |
        echo "Checking for test result files in: ${{ parameters.buildDirectory }}/${{ testResultDir }}"
        if ls ${{ parameters.buildDirectory }}/${{ testResultDir }}/**/*junit-report.xml 1> /dev/null 2>&1; then
          echo "Test result files found."
          echo "##vso[task.setvariable variable=hasTestResults_${{ testResultDir }}]true"
        else
          echo "No test result files found."
          echo "##vso[task.setvariable variable=hasTestResults_${{ testResultDir }}]false"
        fi
      displayName: Check Test Result Files in ${{ testResultDir }}

    # Publish test results only if files exist to avoid unnecessary tasks and warnings
    - task: PublishTestResults@2
      displayName: Publish Test Results in ${{ testResultDir }}
      inputs:
        testResultsFormat: 'JUnit'
        testResultsFiles: '**/*junit-report.xml'
        searchFolder: ${{ parameters.buildDirectory }}/${{ testResultDir }}
        mergeTestResults: false
      condition: and(succeededOrFailed(), eq(variables['startTest'], 'true'), eq(variables['hasTestResults_${{ testResultDir }}'], 'true'))
