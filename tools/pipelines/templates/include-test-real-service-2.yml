# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-test-real-service

parameters:
- name: poolBuild
  type: object
  default: Small

- name: testPackage
  type: string
  default: "@fluid-private/test-end-to-end-tests"

- name: testWorkspace
  type: string

- name: timeoutInMinutes
  type: number
  default: 60

- name: env
  type: object
  default:

- name: splitTestVariants
  type: object
  default:
  - name: ""
    flags: ""

- name: stageVariables
  type: object
  default:

- name: testCommand
  type: string

- name: continueOnError
  type: boolean
  default: false

- name: testFileTarName
  type: string
  default: null

# Id of the pipeline run that contains the artifacts to download.
# Needed to workaround a bug in the DownloadPipelineArtifact task that might cause artifacts to be downloaded from the
# incorrect pipeline run (see https://github.com/microsoft/azure-pipelines-tasks/issues/13518).
- name: artifactBuildId
  type: string

# Name of the Secure File that contains the self-signed cert for the R11s deployment.
# If not blank, the pipeline will try to install it to the local cert store.
- name: r11sSelfSignedCertSecureFile
  type: string
  default: ""

- name: condition
  type: string
  default: true

- name: loggerPackage
  type: string
  default: '@ff-internal/aria-logger'

# If true, skip publishing report files for test results.
# Useful because our stress tests pipeline doesn't generate any test result files.
- name: skipTestResultPublishing
  type: boolean
  default: false

# Custom steps specified by the "caller" of this template, for any additional things that need to be done
# after the steps in this template complete.
- name: additionalSteps
  type: stepList
  default: []

# If true, the versions of our packages installed for compat testing will be cached.
- name: cacheCompatVersionsInstalls
  type: boolean
  default: false

# Id for the stage that runs tests
- name: stageId
  type: string

# Display name for the stage that runs tests
- name: stageDisplayName
  type: string

# If true, the stage that uploads pipeline telemetry to Kusto will include a task to upload
# test pass rate telemetry.
- name: uploadTestPassRateTelemetry
  type: boolean
  default: false

# Unique identifier used to identify telemetry data in Kusto for this pipeline
- name: pipelineIdentifierForTelemetry
  type: string

stages:
- stage: ${{ parameters.stageId}}
  displayName: ${{ parameters.stageDisplayName }}
  dependsOn: []
  ${{ if parameters.stageVariables }}:
    variables:
      ${{ parameters.stageVariables }}
  jobs:
  - template: /tools/pipelines/templates/include-test-real-service.yml@self
    parameters:
      poolBuild: ${{ parameters.poolBuild }}
      testPackage: ${{ parameters.testPackage }}
      testWorkspace: ${{ parameters.testWorkspace }}
      timeoutInMinutes: ${{ parameters.timeoutInMinutes }}
      env: ${{ parameters.env }}
      splitTestVariants: ${{ parameters.splitTestVariants }}
      testCommand: ${{ parameters.testCommand}}
      continueOnError: ${{ parameters.continueOnError }}
      testFileTarName: ${{ parameters.testFileTarName }}
      artifactBuildId: ${{ parameters.artifactBuildId }}
      r11sSelfSignedCertSecureFile: ${{ parameters.r11sSelfSignedCertSecureFile }}
      condition: ${{ parameters.condition }}
      loggerPackage: ${{ parameters.loggerPackage }}
      skipTestResultPublishing: ${{ parameters.skipTestResultPublishing }}
      additionalSteps: ${{ parameters.additionalSteps }}
      cacheCompatVersionsInstalls: ${{ parameters.cacheCompatVersionsInstalls }}

- template: /tools/pipelines/templates/include-upload-stage-telemetry.yml@self
  parameters:
    stageId: ${{ parameters.stageId }}
    uploadTestPassRateTelemetry: ${{ parameters.uploadTestPassRateTelemetry }}
    pipelineIdentifierForTelemetry: ${{ parameters.pipelineIdentifierForTelemetry }}
    testWorkspace: ${{ parameters.testWorkspace }}
