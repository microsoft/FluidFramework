
parameters:
- name: buildDirectory
  type: string
- name: containerName
  type: string

trigger: none

variables:
- name: pushImage
  value: ${{
        and(
            ne(variables['Build.Reason'], 'PullRequest'),
            eq(variables['Build.SourceBranch'], 'refs/heads/master')
        )}}

- name: containerRegistry
  value:

- ${{ if eq(variables.pushImage, true) }}:
  - name: containerRegistry
    value: Fluid Azure Container Registry

- name: fullContainerTag
  value: $(containerRegistry)/$(containerName):$(Build.BuildId)

steps:
# Setup
- checkout: self
  clean: true
  fetchDepth: 1
  lfs: false
  submodules: false

- task: Bash@3
  displayName: Strip npmrc auth token preamble
  inputs:
    targetType: 'inline'
    script: |
      # In order to simplify the build and use the npm authenticate task we strip the auth token preamble from the npmrc
      sed -i '/^; begin auth token/,/^\; end auth token/d;' ${{ parameters.buildDirectory }}/.npmrc

- task: npmAuthenticate@0
  displayName: 'npm Authenticate ${{ parameters.buildDirectory }}/.npmrc'
  inputs:
    workingFile: ${{ parameters.buildDirectory }}/.npmrc

- task: Docker@2
  displayName: Docker Build
  inputs:
    containerRegistry: $(containerRegistry)
    repository: $(containerName)
    command: build
    dockerFile: $(buildDirectory)/Dockerfile
    buildContext: $(buildDirectory)
    tags: |
      $(Build.BuildId)

- ${{ if eq(variables.pushImage, true) }}:
  - task: Docker@2
    displayName: Docker Push
    inputs:
      containerRegistry: $(containerRegistry)
      repository: $(containerName)
      command: push
      tags: |
        $(Build.BuildId)

# Cleanup
- task: Docker@0
  displayName: Docker Cleanup - Container prune
  inputs:
    action: Run a Docker command
    customCommand: container prune -f
  continueOnError: true
  condition: succeededOrFailed()

- task: Docker@0
  displayName: Docker Cleanup - $(baseContainer)
  inputs:
    action: Run a Docker command
    customCommand: rmi $(fullContainerTag)
  continueOnError: true
  condition: succeededOrFailed()