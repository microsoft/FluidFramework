# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# include-conditionally-run-stress-tests
# Checks if

parameters:
- name: packages
  type: object # { name, affectedPaths, testFileTarName, testCommand } all strings

- name: testWorkspace
  type: string

- name: pool
  type: object
  default: Small

stages:
  - stage: CheckAffectedPaths
    displayName: Determine changed packages
    jobs:
    - job: Job
      displayName: Check for DDS package changes
      steps:
      - ${{ each package in parameters.packages }}:
        - task: PowerShell@2
          inputs:
            targetType: 'inline'
            script: |
              $changedfiles = git diff --name-only ${{ package.affectedPaths }}
              Write-Host "Found the following files changed in ${{ package.affectedPaths }}:"
              Write-Host $changedfiles
              If ($changedfiles -ne $null)  {
                echo "##vso[task.setvariable variable=AffectedFilesModified;isOutput=true]true"
              }
          displayName: 'Check if files affecting ${{ package.affectedPaths }} were modified'
          name: "Check${{ replace(package.testFileTarName, '-', '' ) }}"

  - ${{ each package in parameters.packages }}:
    - stage:
      condition: eq(dependencies.CheckAffectedPaths.Job.outputs["Check${{ replace(package.testFileTarName, '-', '' ) }}.AffectedFilesModified"],'true')
      dependsOn: CheckAffectedPaths
      displayName: Run stress tests - ${{ package.name }}
      jobs:
        - template: include-test-real-service.yml
          parameters:
            poolBuild: ${{ parameters.pool }}
            extraDependencies: mocha @fluid-internal/stochastic-test-utils
            testPackage: ${{ package.name }}
            testWorkspace: ${{ parameters.testWorkspace }}
            timeoutInMinutes: 120
            testFileTarName: ${{ package.testFileTarName }}
            testCommand: ${{ package.testCommand }}
            env:
              FLUID_TEST_LOGGER_PKG_PATH: ${{ variables.testWorkspace }}/node_modules/@ff-internal/aria-logger # Contains getTestLogger impl to inject
              FUZZ_STRESS_RUN: true
