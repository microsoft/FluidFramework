# This Yaml Document has been converted by ESAI Yaml Pipeline Conversion Tool.
# Please make sure to check all the converted content, it is your team's responsibility to make sure that the pipeline is still valid and functions as expected.
# The Task 'PublishPipelineArtifact@1' has been converted to an output named 'Publish api-extractor JSON' in the templateContext section.
parameters:
- name: STORAGE_ACCOUNT
  type: string
- name: STORAGE_KEY
  type: string
- name: uploadAsLatest
  type: boolean
  default: false
steps:
- checkout: none
  clean: true
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - common-definitions
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - common-utils
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - container-definitions
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - core-interfaces
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - driver-definitions
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - protocol-definitions
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - azure
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: Build - client packages
    branchName: ${{ variables['Build.SourceBranch'] }}
- template: /tools/pipelines/templates/download-api-extractor-artifact.yml@self
  parameters:
    pipelineName: server-routerlicious
    branchName: ${{ variables['Build.SourceBranch'] }}
- task: CopyFiles@2
  displayName: 'Copy and merge JSON files'
  inputs:
    SourceFolder: $(Pipeline.Workspace)
    Contents: '**/*.api.json'
    TargetFolder: '$(Build.SourcesDirectory)/_api-extractor-temp'
    OverWrite: false
    flattenFolders: true
    CleanTargetFolder: true
- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/_api-extractor-temp'
    includeRootFolder: false
    archiveType: 'tar'
    tarCompression: 'gz'
    archiveFile: '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz'
    replaceExistingArchive: true
    verbose: true
- task: AzureCLI@2
  displayName: 'Upload JSON'
  continueOnError: true
  inputs:
    azureSubscription: 'fluid-docs'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az storage blob upload -f '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz' -c 'api-extractor-json' -n $(Build.SourceVersion).tar.gz --account-name ${{ parameters.STORAGE_ACCOUNT }} --account-key ${{ parameters.STORAGE_KEY }} --verbose
- ${{ if eq(parameters.uploadAsLatest, true) }}:
  - task: AzureCLI@2
    displayName: 'Upload JSON as latest.tar.gz'
    continueOnError: true
    inputs:
      azureSubscription: 'fluid-docs'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az storage blob upload -f '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz' -c 'api-extractor-json' -n latest.tar.gz --account-name ${{ parameters.STORAGE_ACCOUNT }} --account-key ${{ parameters.STORAGE_KEY }} --overwrite --verbose
