# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# upload-json-steps pipeline

parameters:
- name: STORAGE_ACCOUNT
  type: string

- name: STORAGE_KEY
  type: string

- name: uploadAsLatest
  type: boolean
  default: false

steps:
- checkout: none
  clean: true

# Download the api-extractor outputs
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - common-definitions
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - common-utils
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - container-definitions
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - core-interfaces
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - driver-definitions
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - protocol-definitions
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - azure
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: Build - client packages
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true   
- task: DownloadPipelineArtifact@2
  inputs:
    buildType: specific
    project: internal
    pipeline: server-routerlicious
    buildVersionToDownload: latestFromBranch
    branchName: ${{ variables['Build.SourceBranch'] }}
    artifact: _api-extractor-temp
    allowPartiallySucceededBuilds: true

# Copy and merge the api-extractor outputs to a central location
- task: CopyFiles@2
  displayName: 'Copy and merge JSON files'
  inputs:
    SourceFolder: $(Pipeline.Workspace)
    Contents: '**/*.api.json'
    TargetFolder: '$(Build.SourcesDirectory)/_api-extractor-temp'
    OverWrite: false
    flattenFolders: true
    CleanTargetFolder: true

- task: PublishPipelineArtifact@1
  displayName: 'Publish api-extractor JSON'
  inputs:
    targetPath: '$(Build.SourcesDirectory)/_api-extractor-temp'
    artifactName: 'api-extractor-combined'
    publishLocation: 'pipeline'

- task: ArchiveFiles@2
  inputs:
    rootFolderOrFile: '$(Build.SourcesDirectory)/_api-extractor-temp'
    includeRootFolder: false
    archiveType: 'tar' # Options: zip, 7z, tar, wim
    tarCompression: 'gz' # Optional. Options: gz, bz2, xz, none
    archiveFile: '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz'
    replaceExistingArchive: true
    verbose: true # Optional
    #quiet: # Optional

- task: AzureCLI@2
  displayName: 'Upload JSON'
  continueOnError: true
  inputs:
    azureSubscription: 'fluid-docs'
    scriptType: bash
    scriptLocation: inlineScript
    inlineScript: |
      az storage blob upload -f '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz' -c 'api-extractor-json' -n $(Build.SourceVersion).tar.gz --account-name ${{ parameters.STORAGE_ACCOUNT }} --account-key ${{ parameters.STORAGE_KEY }} --verbose

- ${{ if eq(parameters.uploadAsLatest, true) }}:
  - task: AzureCLI@2
    displayName: 'Upload JSON as latest.tar.gz'
    continueOnError: true
    inputs:
      azureSubscription: 'fluid-docs'
      scriptType: bash
      scriptLocation: inlineScript
      inlineScript: |
        az storage blob upload -f '$(Pipeline.Workspace)/$(Build.SourceVersion).tar.gz' -c 'api-extractor-json' -n latest.tar.gz --account-name ${{ parameters.STORAGE_ACCOUNT }} --account-key ${{ parameters.STORAGE_KEY }} --overwrite --verbose
