# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

trigger: none
pr: none

resources:
  pipelines:
  - pipeline: build   # Name of the pipeline resource
    source: Build - build-common # Name of the triggering pipeline
    trigger: 
      branches:
      - releases/*
      - master

jobs:
- deployment: publish
  displayName: Publish build-common
  pool: Shared
  environment: 'fluid-feed'
  variables:
    - name: feed
      value: https://offnet.pkgs.visualstudio.com/officenet/_packaging/fluid/npm/registry/
  strategy:
    runOnce:
        deploy:
            steps:
            - download: build
              artifact: pack
            - task: Bash@3
              displayName: Generate .npmrc
              inputs:
                targetType: 'inline'
                workingDirectory: $(Pipeline.Workspace)/build/pack
                script: |
                  echo Generating .npmrc for $(feed)
                  echo "@fluidframework:registry=$(feed)" >> ./.npmrc
                  echo "@fluid-example:registry=$(feed)" >> ./.npmrc
                  echo "always-auth=true" >> ./.npmrc
            - task: npmAuthenticate@0
              displayName: npm Authenticate
              inputs:
                workingFile: $(Pipeline.Workspace)/build/pack/.npmrc
            - task: Bash@3
              displayName: Publish Packages
              inputs:
                targetType: 'inline'
                workingDirectory: $(Pipeline.Workspace)/build/pack
                script: |
                  tag="--tag canary"
                  if [[ "$(Build.SourceBranch)" = refs/heads/master ]]; then
                    tag="--tag next"
                  elif [[ "$(Build.SourceBranch)" == refs/tags/* ]]; then
                    tag="--tag latest"
                  fi
                  echo Tag: $tag
                  t1=0
                  for f in *.tgz
                  do 
                      if ! npm publish $f $tag
                      then
                          let t1+=1
                      fi
                  done
                  exit $t1


