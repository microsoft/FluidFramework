# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# build-performance-observability pipeline
# This pipeline collects build metrics using ADO REST APIs and generates an HTML dashboard
# which is uploaded to an Azure Static Web App (ASWA).
# When run from the "public" project: collects PR build metrics
# When run from the "internal" project: collects internal build metrics

name: $(Build.BuildId)

# Both schedules run in both projects (public and internal), but each schedule
# only completes in one of the projects (the other project will skip early).
# - 2 AM UTC: PR build metrics - runs in public, skips in internal
# - 3 AM UTC: Internal build metrics - runs in internal, skips in public
# This is done to avoid a race condition if both runs try to update the ASWA at the same time.
schedules:
- cron: "0 2 * * *"
  displayName: Daily PR build metrics collection
  branches:
    include:
    - main
  always: true
- cron: "0 3 * * *"
  displayName: Daily internal build metrics collection
  branches:
    include:
    - main
  always: true

trigger: none

pr: none

variables:
  # Contains keys to upload dashboard to ASWA
  - group: build-perf-dashboard-vars
  # Number of recent builds to fetch
  - name: buildCount
    value: 500
  # Organization
  - name: organization
    value: fluidframework
  # Mode: public = PR builds, internal = internal builds
  - name: isPublicProject
    value: ${{ eq(variables['System.TeamProject'], 'public') }}
  # Build definition IDs
  - name: publicPRBuildDefinitionId
    value: 11
  - name: internalBuildDefinitionId
    value: 12
  # Project to query (same as where pipeline runs)
  - name: targetProject
    value: $(System.TeamProject)
  # GitHub repository for source links
  - name: githubRepo
    value: microsoft/FluidFramework
  # Max concurrent API requests when fetching timeline data
  - name: parallelJobs
    value: 20

resources:
  repositories:
  - repository: m365Pipelines
    type: git
    name: 1ESPipelineTemplates/M365GPT
    ref: refs/tags/release

extends:
  template: v1/M365.Unofficial.PipelineTemplate.yml@m365Pipelines
  parameters:
    customBuildTags:
    - ES365AIMigrationTooling
    pool:
      name: Small-eastus2
      os: linux
    sdl:
      sourceAnalysisPool:
        name: Azure-Pipelines-1ESPT-ExDShared
        image: windows-2022
        os: windows

    stages:
    - stage: collect_metrics
      displayName: Collect Build Metrics
      jobs:
      - job: collect_and_publish
        displayName: Collect and Publish Build Metrics
        steps:
        - checkout: self
          clean: true

        # Determine if we should skip the remainder of the pipeline
        # This happens if we are running from the cron schedule and the run was intended
        # for the other project (public vs internal).
        - task: Bash@3
          name: detect
          displayName: Detect run mode
          env:
            IS_PUBLIC: $(isPublicProject)
            BUILD_REASON: $(Build.Reason)
            CRON_SCHEDULE_NAME: $(Build.CronSchedule.DisplayName)
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/tools/pipelines/build-performance-observability-utils/detect-run-mode.sh'

        - task: Bash@3
          displayName: Fetch build data
          condition: eq(variables['shouldRun'], 'true')
          env:
            ADO_API_TOKEN: $(System.AccessToken)
            PR_BUILD_DEF_ID: $(publicPRBuildDefinitionId)
            INTERNAL_BUILD_DEF_ID: $(internalBuildDefinitionId)
            BUILD_COUNT: $(buildCount)
            ORG: $(organization)
            PROJECT: $(targetProject)
            MODE: $(runMode)
            OUTPUT_DIR: $(Build.ArtifactStagingDirectory)
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/tools/pipelines/build-performance-observability-utils/fetch-build-data.sh'

        - task: Bash@3
          displayName: Fetch timeline data for builds
          condition: eq(variables['shouldRun'], 'true')
          env:
            ADO_API_TOKEN: $(System.AccessToken)
            ORG: $(organization)
            PROJECT: $(targetProject)
            PARALLEL_JOBS: $(parallelJobs)
            MODE: $(runMode)
            OUTPUT_DIR: $(Build.ArtifactStagingDirectory)
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/tools/pipelines/build-performance-observability-utils/fetch-timeline-data.sh'

        - task: Bash@3
          displayName: Generate data JSON
          condition: eq(variables['shouldRun'], 'true')
          env:
            MODE: $(runMode)
            OUTPUT_DIR: $(Build.ArtifactStagingDirectory)
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/tools/pipelines/build-performance-observability-utils/generate-data-json.sh'

        - task: Bash@3
          displayName: Prepare deployment package
          condition: eq(variables['shouldRun'], 'true')
          env:
            ASWA_HOSTNAME: $(ASWA_HOSTNAME)
            MODE: $(runMode)
            OUTPUT_DIR: $(Build.ArtifactStagingDirectory)
            SOURCE_DIR: $(Build.SourcesDirectory)
            DEPLOY_DIR: $(Build.ArtifactStagingDirectory)/deploy
          inputs:
            targetType: 'filePath'
            filePath: '$(Build.SourcesDirectory)/tools/pipelines/build-performance-observability-utils/prepare-deployment.sh'

        - task: AzureStaticWebApp@0
          displayName: Deploy to Azure Static Web Apps
          condition: eq(variables['shouldRun'], 'true')
          inputs:
            skip_app_build: true
            skip_api_build: true
            cwd: $(Build.ArtifactStagingDirectory)
            app_location: 'deploy'
            output_location: ''
            azure_static_web_apps_api_token: $(ASWA_DEPLOYMENT_TOKEN)

        - task: Bash@3
          displayName: Clean up
          condition: eq(variables['shouldRun'], 'true')
          inputs:
            targetType: 'inline'
            script: |
              echo "Cleaning up temporary files..."
              rm -rf "$(Build.ArtifactStagingDirectory)/metrics"
              rm -rf "$(Build.ArtifactStagingDirectory)/deploy"
              rm -f "$(Build.ArtifactStagingDirectory)"/*.json
              echo "Cleanup complete"
