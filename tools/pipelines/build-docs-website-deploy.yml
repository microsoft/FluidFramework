# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# build-docs-website-deploy pipeline
# This pipeline triggers on the completion of the build-docs pipeline (main branch run).
# After the build-docs pipeline completes, this pipeline downloads the generated fluidframework-docs
# artifacts and deploys the content using AzureStaticWebApp.
# This pipeline also has a scheduled trigger which runs every 4 hours.

name: $(Build.BuildId)

schedules:
  - cron: "0 */4 * * *"
    displayName: Website deploy with 4 hour increments
    branches:
      include:
        - main
    always: true
pr: none

parameters:
- name: deployOverride
  displayName: Deployment Override (default = based on branch)
  type: string
  default: default
  values:
    - default
    - skip
    - force
- name: deployEnvironment
  displayName: Static web app environment to deploy to
  type: string
  default: new
  values:
    - new
    - old

variables:
- group: storage-vars
- name: shouldDeploy
  value: ${{ or(
    eq(parameters.deployOverride, 'force'),
    and(eq(variables['Build.SourceBranchName'], 'main'), eq(parameters.deployOverride, 'default'))
    )}}
- name: deploymentToken
  ${{ if eq( parameters['deployEnvironment'], 'new' ) }}:
    value: "$(FLUID_WEBSITE_TORUS_API_TOKEN)"
  ${{ if eq( parameters['deployEnvironment'], 'old') }}:
    value: "$(AZURE_STATIC_WEB_APPS_API_TOKEN)"

# We are setting up a pipeline resource that references the build-docs
# pipeline and setting up a pipeline completion trigger so that our build-docs-website-deploy
# pipeline runs when a run of the build-docs pipeline completes
resources:
  pipelines:
  - pipeline: build-docs # Name of the pipeline resource.
    source: build-docs # The name of the pipeline referenced by this pipeline resource.
    trigger: 
      branches:
        include: 
        - main # Run pipeline when build-docs main branch pipeline completes

stages:
- stage: deploy
  displayName: 'Deploy website'
  pool: Small
  jobs:
    - job: deploy_site
      displayName: 'Deploy website'
      steps:
        - task: DownloadPipelineArtifact@2
          displayName: 'Copy fluidframework-docs to public folder'
          inputs:
            source: specific
            project: internal
            pipeline: build-docs
            branchName: main
            buildVersionToDownload: latestFromBranch
            artifact: fluidframework-docs
            path: '$(Build.SourcesDirectory)'

        - task: AzureStaticWebApp@0
          displayName: 'Deploy website to ASWA'
          condition: eq(variables.shouldDeploy, true)
          inputs:
            skip_app_build: true # site was built in previous stage
            skip_api_build: true # api is written in js, no build needed
            cwd: $(Build.SourcesDirectory)
            app_location: 'docs-temp/public'
            api_location: 'docs-temp/api'
            output_location: ''
            azure_static_web_apps_api_token: '${{ variables.deploymentToken }}'
