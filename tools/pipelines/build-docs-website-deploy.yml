# Copyright (c) Microsoft Corporation and contributors. All rights reserved.
# Licensed under the MIT License.

# build-docs-website-deploy pipeline

name: $(Build.BuildId)

schedules:
  - cron: "0 4 * * *"
    displayName: Daily 8pm (PST) website deploy
    branches:
      include:
        - main
    always: true

trigger: none
pr: none

parameters:
- name: deployOverride
  displayName: Deployment Override (default = based on branch)
  type: string
  default: default
  values:
    - default
    - skip
    - force
- name: deployEnvironment
  displayName: Static web app environment to deploy to
  type: string
  default: new
  values:
    - new
    - old

variables:
- name: shouldDeploy
  value: ${{ or(
    eq(parameters.deployOverride, 'force'),
    and(eq(variables['Build.SourceBranchName'], 'main'), eq(parameters.deployOverride, 'default'))
    )}}
- name: deploymentToken
  ${{ if eq( parameters['deployEnvironment'], 'new' ) }}:
    value: "$(FLUID_WEBSITE_TORUS_API_TOKEN)"
  ${{ if eq( parameters['deployEnvironment'], 'old') }}:
    value: "$(AZURE_STATIC_WEB_APPS_API_TOKEN)"

stages:
- stage: deploy
  displayName: 'Deploy website'
  pool: Small
  jobs:
    - job: deploy_site
      displayName: 'Deploy website'
      steps:
        - task: DownloadPipelineArtifact@2
          displayName: 'Copy fluidframework-docs to public folder'
          inputs:
            source: specific
            project: internal
            pipeline: build-docs
            branchName: main
            buildVersionToDownload: latestFromBranch
            artifact: fluidframework-docs
            path: '$(Build.SourcesDirectory)/docs/public'

        - task: DownloadPipelineArtifact@2
          displayName: 'Copy fluidframework-docs-api to api folder'
          inputs:
            source: specific
            project: internal
            pipeline: build-docs
            branchName: main
            buildVersionToDownload: latestFromBranch
            artifact: fluidframework-docs-api
            path: '$(Build.SourcesDirectory)/docs/api'

        - task: AzureStaticWebApp@0
          displayName: 'Deploy website to ASWA'
          condition: eq(variables.shouldDeploy, true)
          inputs:
            skip_app_build: true # site was built in previous stage
            skip_api_build: true # api is written in js, no build needed
            cwd: $(Build.SourcesDirectory)
            app_location: 'docs/public'
            api_location: 'docs/api'
            output_location: ''
            azure_static_web_apps_api_token: '${{ variables.deploymentToken }}'