# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.

# deploy-docs pipeline

name: $(Build.BuildId)

variables:
  - group: doc-versions
  - group: storage-vars
  - name: latestPipeline
    value: ${{ or(
      eq(variables['Build.SourceBranchName'], 'master'),
      eq(variables['Build.SourceBranchName'], 'api-pipeline')
      )}}
  # - name: n1Branch
  #   value: ${{ join('/refs/heads/release/', variables['N1_BRANCH']) }}
  - name: n1Pipeline
    value: ${{ eq(variables['Build.SourceBranchName'], variables['N1_BRANCH']) }}
  - name: releasePipeline
    value: ${{ eq(variables['Build.SourceBranchName'], variables['RELEASE_BRANCH']) }}
  - name: validRun
    value: ${{ or(variables.releasePipeline, variables.n1Pipeline, variables.latestPipeline) }}

resources:
  pipelines:
  - pipeline: docs
    source: build-docs
    trigger:
      branches:
        include:
          - release/*
          - master

# no branch and PR triggers
trigger: none
pr: none

stages:
  - stage: deploy
    displayName: 'Deploy docs'
    pool: Default
    jobs:
    # current release
    - ${{ if eq(variables.releasePipeline, true) }}:
      - deployment: current_release
        displayName: 'Deploy docs v $[variablegroups.doc-versions.RELEASE_VERSION]'
        steps:
        - template: templates/deploy-docs-steps.yml
          parameters:
            STORAGE_ACCOUNT: $(STORAGE_ACCOUNT)
            STORAGE_KEY: $(STORAGE_KEY)
            DEST_PATH: '/'

      - deployment: current_release_versioned
        displayName: 'Deploy docs v $[variablegroups.doc-versions.RELEASE_VERSION] (version path)'
        steps:
        - template: templates/deploy-docs-steps.yml
          parameters:
            STORAGE_ACCOUNT: $(STORAGE_ACCOUNT)
            STORAGE_KEY: $(STORAGE_KEY)
            DEST_PATH: '/versions/$(RELEASE_VERSION)/'

    # latest - master branch
    - ${{ if eq(variables.latestPipeline, true) }}:
      - deployment: latest_release
        displayName: 'Deploy docs v $[variablegroups.doc-versions.MASTER_BRANCH_VERSION]'
        steps:
        - template: templates/deploy-docs-steps.yml
          parameters:
            STORAGE_ACCOUNT: $(STORAGE_ACCOUNT)
            STORAGE_KEY: $(STORAGE_KEY)
            DEST_PATH: '/'

      - deployment: latest_release_versioned
        displayName: 'Deploy docs v $[variablegroups.doc-versions.MASTER_BRANCH_VERSION] (version path)'
        steps:
        - template: templates/deploy-docs-steps.yml
          parameters:
            STORAGE_ACCOUNT: $(STORAGE_ACCOUNT)
            STORAGE_KEY: $(STORAGE_KEY)
            DEST_PATH: '/versions/$(MASTER_BRANCH_VERSION)/'

    # n-1 release
    - ${{ if eq(variables.n1Pipeline, true) }}:
      - deployment: old_release
        displayName: 'Deploy docs v $[variablegroups.doc-versions.N1_VERSION] (version path)'
        steps:
        - template: templates/deploy-docs-steps.yml
          parameters:
            STORAGE_ACCOUNT: $(STORAGE_ACCOUNT)
            STORAGE_KEY: $(STORAGE_KEY)
            DEST_PATH: '/versions/$(N1_VERSION)/'
