name: Push commit to Azure Queue

on:
  push:
    branch: [ main ]

jobs:
  queue-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.label.name != 'do-not-merge-in-next' }}
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-node@v2
        with:
          node-version: 14
      - run: npm ci
      - run: npm install @azure/storage-queue
      - uses: actions/github-script@v6
        with:
          script: |
            const { QueueClient, QueueServiceClient } = require('@azure/storage-queue')
            const connectionString = 'DefaultEndpointsProtocol=https;AccountName=sonalideshpande;AccountKey=MjQlPAznKPTbFwOME9pw7yOB8vHkn+4TGAIi2fMs2+UG21EyT32Uqk3+mTt2xXMwpd4lKY5vxEuM+AStE9pX1w==;EndpointSuffix=core.windows.net';
            const queueName = 'main-next-integration';
            const queueServiceClient = QueueServiceClient.fromConnectionString(connectionString);
            const queueClient = queueServiceClient.getQueueClient(queueName);
            console.log("SHA-----", `${{ github.sha }}`);
            console.log("SHA-----", `${{ github.author }}`);
            const message = {
              sha: `${{ github.sha }}`,
              author: `${{ github.author }}`,
              label: `queued`,
            };
            await queueClient.sendMessage(JSON.stringify(message));
  add-comment:
    runs-on: ubuntu-latest
    needs: [queue-pr]
    steps:
      - name: Create commit comment
        uses: peter-evans/commit-comment@v2
        with:
          body: |
            'Commit queued for merging with the test_next branch! Please ignore the comment for now.'
