name: Push commit to Azure Queue

on:
  push:
    branch: [ main ]

jobs:
  queue-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.label.name != 'do-not-merge-in-next' }}
    steps:
      - name: Install Azure Storage
        run: npm i -g @azure/storage-queue
      - name: Queue Commit
        uses: actions/checkout@v2
        uses: actions/github-script@v6
        with:
          script: |
            const { QueueClient, QueueServiceClient } = require('@azure/storage-queue');
            const connectionString = `${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}`;
            const queueName = `${{ secrets.AZURE_QUEUE_NAME }}`;
            const queueServiceClient = QueueServiceClient.fromConnectionString(connectionString);
            const queueClient = queueServiceClient.getQueueClient(queueName);
            const message = {
              sha: `${{ github.event.pull_request.head.sha }}`,
              author: `${{ github.author }}`,
              label: `queued`,
            };
            await queueClient.sendMessage(JSON.stringify(message));
  add-comment:
    runs-on: ubuntu-latest
    needs: [queue-pr]
    steps:
      - name:  add-conflict-comment
        uses: thollander/actions-comment-pull-request@v1
        with:
          message: 'Commit queued for merging with the test_next branch! Please ignore the comment for now.'
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
