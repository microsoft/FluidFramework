name: Website validation
on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - "docs/**"

jobs:
  build_site:
    runs-on: ubuntu-latest
    name: Build site
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: false
    - uses: actions/setup-node@v2-beta
      with:
        node-version: "12"
    - name: Build site artifact
      run: |
        cd $GITHUB_WORKSPACE/docs
        npm ci
        npm run download
        npm run build
    - name: Upload site artifact
      uses: actions/upload-artifact@v2
      with:
        name: fluidframework-site
        path: docs/public
        retention-days: 3

  broken_link_check_internal:
    runs-on: ubuntu-latest
    name: 🔗 Broken Link Check
    needs: build_site
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: false
    - uses: actions/setup-node@v2-beta
      with:
        node-version: "12"
    - name: Download site artifact
      uses: actions/download-artifact@v2
      with:
        name: fluidframework-site
        path: docs/public
    - name: Install dependencies
      run: |
        npm install pm2 -g
        cd $GITHUB_WORKSPACE/docs
        npm ci
    - name: Start server in background
      run: |
        cd $GITHUB_WORKSPACE/docs
        pm2 start $GITHUB_WORKSPACE/docs/serve.js
    - name: Check internal links
      id: linkcheck
      run: |
        cd $GITHUB_WORKSPACE/docs
        npm run linkcheck
    - name: Report success
      if: ${{ success() && steps.linkcheck.outcome == 'success' }}
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: linkreport
        recreate: true
        message: |
          ### Broken link report 👍🏻

          🔗 No broken links found! ✅

          Your attention to detail is admirable.
    - name: Report failure
      if: ${{ failure() || steps.linkcheck.outcome != 'success' }}
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: linkreport
        recreate: true
        message: |
          ### Broken link report ⚠

          🔗 Found some broken links! 💔

          Run a link check locally to find them. See
          <https://github.com/microsoft/FluidFramework/wiki/Checking-for-broken-links-in-the-documentation> for more information.
