{"version":3,"file":"CustomMarkdownEmitter.js","sourceRoot":"","sources":["../../src/markdown/CustomMarkdownEmitter.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright (c) Microsoft Corporation. All rights reserved. Licensed under the MIT license.\r\n// See LICENSE in the project root for license information.\r\n\r\nimport * as colors from 'colors';\r\n\r\nimport { DocNode, DocLinkTag, StringBuilder } from '@microsoft/tsdoc';\r\nimport { ApiModel, IResolveDeclarationReferenceResult, ApiItem } from '@microsoft/api-extractor-model';\r\n\r\nimport { CustomDocNodeKind } from '../nodes/CustomDocNodeKind';\r\nimport { DocHeading } from '../nodes/DocHeading';\r\nimport { DocNoteBox } from '../nodes/DocNoteBox';\r\nimport { DocTable } from '../nodes/DocTable';\r\nimport { DocTableCell } from '../nodes/DocTableCell';\r\nimport { DocEmphasisSpan } from '../nodes/DocEmphasisSpan';\r\nimport { MarkdownEmitter, IMarkdownEmitterContext, IMarkdownEmitterOptions } from './MarkdownEmitter';\r\nimport { IndentedWriter } from '../utils/IndentedWriter';\r\n\r\nexport interface ICustomMarkdownEmitterOptions extends IMarkdownEmitterOptions {\r\n  contextApiItem: ApiItem | undefined;\r\n\r\n  onGetFilenameForApiItem: (apiItem: ApiItem) => string | undefined;\r\n}\r\n\r\nexport class CustomMarkdownEmitter extends MarkdownEmitter {\r\n  private _apiModel: ApiModel;\r\n\r\n  public constructor(apiModel: ApiModel) {\r\n    super();\r\n\r\n    this._apiModel = apiModel;\r\n  }\r\n\r\n  public emit(\r\n    stringBuilder: StringBuilder,\r\n    docNode: DocNode,\r\n    options: ICustomMarkdownEmitterOptions\r\n  ): string {\r\n    return super.emit(stringBuilder, docNode, options);\r\n  }\r\n\r\n  /** @override */\r\n  protected writeNode(docNode: DocNode, context: IMarkdownEmitterContext, docNodeSiblings: boolean): void {\r\n    const writer: IndentedWriter = context.writer;\r\n\r\n    switch (docNode.kind) {\r\n      case CustomDocNodeKind.Heading: {\r\n        const docHeading: DocHeading = docNode as DocHeading;\r\n        writer.ensureSkippedLine();\r\n\r\n        let prefix: string;\r\n        switch (docHeading.level) {\r\n          case 1:\r\n            prefix = '##';\r\n            break;\r\n          case 2:\r\n            prefix = '###';\r\n            break;\r\n          case 3:\r\n            prefix = '###';\r\n            break;\r\n          default:\r\n            prefix = '####';\r\n        }\r\n\r\n        writer.writeLine(prefix + ' ' + this.getEscapedText(docHeading.title));\r\n        writer.writeLine();\r\n        break;\r\n      }\r\n      case CustomDocNodeKind.NoteBox: {\r\n        const docNoteBox: DocNoteBox = docNode as DocNoteBox;\r\n        writer.ensureNewLine();\r\n\r\n        writer.increaseIndent('> ');\r\n\r\n        this.writeNode(docNoteBox.content, context, false);\r\n        writer.ensureNewLine();\r\n\r\n        writer.decreaseIndent();\r\n\r\n        writer.writeLine();\r\n        break;\r\n      }\r\n      case CustomDocNodeKind.Table: {\r\n        const docTable: DocTable = docNode as DocTable;\r\n        // GitHub's markdown renderer chokes on tables that don't have a blank line above them,\r\n        // whereas VS Code's renderer is totally fine with it.\r\n        writer.ensureSkippedLine();\r\n\r\n        context.insideTable = true;\r\n\r\n        // Markdown table rows can have inconsistent cell counts.  Size the table based on the longest row.\r\n        let columnCount: number = 0;\r\n        if (docTable.header) {\r\n          columnCount = docTable.header.cells.length;\r\n        }\r\n        for (const row of docTable.rows) {\r\n          if (row.cells.length > columnCount) {\r\n            columnCount = row.cells.length;\r\n          }\r\n        }\r\n\r\n        // write the table header (which is required by Markdown)\r\n        writer.write('| ');\r\n        for (let i: number = 0; i < columnCount; ++i) {\r\n          writer.write(' ');\r\n          if (docTable.header) {\r\n            const cell: DocTableCell | undefined = docTable.header.cells[i];\r\n            if (cell) {\r\n              this.writeNode(cell.content, context, false);\r\n            }\r\n          }\r\n          writer.write(' |');\r\n        }\r\n        writer.writeLine();\r\n\r\n        // write the divider\r\n        writer.write('| ');\r\n        for (let i: number = 0; i < columnCount; ++i) {\r\n          writer.write(' --- |');\r\n        }\r\n        writer.writeLine();\r\n\r\n        for (const row of docTable.rows) {\r\n          writer.write('| ');\r\n          for (const cell of row.cells) {\r\n            writer.write(' ');\r\n            this.writeNode(cell.content, context, false);\r\n            writer.write(' |');\r\n          }\r\n          writer.writeLine();\r\n        }\r\n        writer.writeLine();\r\n\r\n        context.insideTable = false;\r\n\r\n        break;\r\n      }\r\n      case CustomDocNodeKind.EmphasisSpan: {\r\n        const docEmphasisSpan: DocEmphasisSpan = docNode as DocEmphasisSpan;\r\n        const oldBold: boolean = context.boldRequested;\r\n        const oldItalic: boolean = context.italicRequested;\r\n        context.boldRequested = docEmphasisSpan.bold;\r\n        context.italicRequested = docEmphasisSpan.italic;\r\n        this.writeNodes(docEmphasisSpan.nodes, context);\r\n        context.boldRequested = oldBold;\r\n        context.italicRequested = oldItalic;\r\n        break;\r\n      }\r\n      default:\r\n        super.writeNode(docNode, context, false);\r\n    }\r\n  }\r\n\r\n  /** @override */\r\n  protected writeLinkTagWithCodeDestination(\r\n    docLinkTag: DocLinkTag,\r\n    context: IMarkdownEmitterContext<ICustomMarkdownEmitterOptions>\r\n  ): void {\r\n    const options: ICustomMarkdownEmitterOptions = context.options;\r\n\r\n    const result: IResolveDeclarationReferenceResult = this._apiModel.resolveDeclarationReference(\r\n      docLinkTag.codeDestination!,\r\n      options.contextApiItem\r\n    );\r\n\r\n    if (result.resolvedApiItem) {\r\n      const filename: string | undefined = options.onGetFilenameForApiItem(result.resolvedApiItem);\r\n\r\n      if (filename) {\r\n        let linkText: string = docLinkTag.linkText || '';\r\n        if (linkText.length === 0) {\r\n          // Generate a name such as Namespace1.Namespace2.MyClass.myMethod()\r\n          linkText = result.resolvedApiItem.getScopedNameWithinPackage();\r\n        }\r\n        if (linkText.length > 0) {\r\n          const encodedLinkText: string = this.getEscapedText(linkText.replace(/\\s+/g, ' '));\r\n\r\n          context.writer.write('[');\r\n          context.writer.write(encodedLinkText);\r\n          context.writer.write(`](${filename!})`);\r\n        } else {\r\n          console.log(colors.yellow('WARNING: Unable to determine link text'));\r\n        }\r\n      }\r\n    } else if (result.errorMessage) {\r\n      console.log(\r\n        colors.yellow(\r\n          `WARNING: Unable to resolve reference \"${docLinkTag.codeDestination!.emitAsTsdoc()}\": ` +\r\n            result.errorMessage\r\n        )\r\n      );\r\n    }\r\n  }\r\n}\r\n"]}