/*!
 * Copyright (c) Microsoft Corporation and contributors. All rights reserved.
 * Licensed under the MIT License.
 */

import { strict as assert } from "node:assert";
import type { IFluidCompatibilityMetadata, Logger } from "@fluidframework/build-tools";
import { formatISO } from "date-fns";
import { describe, it } from "mocha";

import {
	DAYS_IN_MONTH_APPROXIMATION,
	generateLayerFileContent,
	isCurrentPackageVersionPatch,
	maybeGetNewGeneration,
} from "../../../library/layerCompatGeneration.js";

describe("check:layerCompatGeneration", () => {
	const minimumCompatWindowMonths = 3;

	// Mock logger that captures log calls for verification
	const createMockLogger = (): Logger => {
		return {
			log: (): void => {},
			info: (): void => {},
			warning: (): void => {},
			errorLog: (): void => {},
			verbose: (): void => {},
		};
	};

	it("should correctly detect patch versions (which should be skipped)", () => {
		assert.strictEqual(isCurrentPackageVersionPatch("1.2.3"), true);
		assert.strictEqual(isCurrentPackageVersionPatch("1.2.0"), false);
		assert.strictEqual(isCurrentPackageVersionPatch("3.0.0"), false);
	});

	it("should detect when generation needs update based on minor version change and time", () => {
		const mockLogger = createMockLogger();
		const previousGeneration = 5;
		const monthsSincePreviousRelease = 1;

		// Create a date monthsSincePreviousRelease months ago
		const oldDate = new Date();
		oldDate.setDate(
			oldDate.getDate() - monthsSincePreviousRelease * DAYS_IN_MONTH_APPROXIMATION,
		);
		const oldDateString = formatISO(oldDate, { representation: "date" });
		const mockMetadata: IFluidCompatibilityMetadata = {
			generation: previousGeneration,
			releaseDate: oldDateString,
			releasePkgVersion: "1.0.0",
		};

		const result = maybeGetNewGeneration(
			"1.1.0", // Minor version change
			mockMetadata,
			minimumCompatWindowMonths,
			mockLogger,
		);

		assert.strictEqual(result, previousGeneration + monthsSincePreviousRelease);
	});

	it("should return undefined when no update is needed", () => {
		const mockLogger = createMockLogger();
		const currentVersion = "2.0.0";
		const mockMetadata: IFluidCompatibilityMetadata = {
			generation: 5,
			releaseDate: "2025-01-01",
			releasePkgVersion: currentVersion,
		};

		const result = maybeGetNewGeneration(
			currentVersion,
			mockMetadata,
			minimumCompatWindowMonths,
			mockLogger,
		);

		assert.strictEqual(result, undefined);
	});

	it("should verify expected file content format", () => {
		const generation = 7;
		const content = generateLayerFileContent(generation);

		// Verify the content includes the expected generation value
		assert(content.includes(`export const generation = ${generation};`));
		// Verify copyright header exists
		assert(content.includes("Copyright (c) Microsoft Corporation"));
		// Verify autogenerated warning
		assert(content.includes("THIS IS AN AUTOGENERATED FILE"));
	});

	it("should detect content mismatch", () => {
		const generation = 7;
		const expectedContent = generateLayerFileContent(generation);
		const wrongContent = generateLayerFileContent(generation + 1);

		assert.notStrictEqual(expectedContent, wrongContent);
	});
});
