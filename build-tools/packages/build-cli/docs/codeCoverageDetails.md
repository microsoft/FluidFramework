# Code coverage

## Overview

This module contains all the utilities required to analyze code coverage metrics from PRs. The coverage metrics generated in the PR build are compared against a baseline CI build for packages that have been updated in the PR. If the line or branch coverage for a package has been impacted in the PR, a comment is posted to the PR showing the diff of the code coverage between baseline and PR.

## Code Coverage Metrics

Code coverage metrics is generated when tests run in the CI pipeline. You can also generate the code coverage metrics for a package locally by running `npm run test:coverage` for the individual package or by running `npm run ci:test:mocha:coverage` from the root.

## Pieces of the code coverage analysis

Code coverage has several steps involving different commands. This section defines those pieces and how they fit together to enable overall code coverage reporting.

### Cobertura coverage files

Code coverage metrics is included in the cobertura-format coverage files we collect during CI builds. These files are currently published as artifacts from both our PR and internal build pipelines to ensure we can run comparisons on PRs against a baseline build.

### Identifying the baseline build

Before running coverage comparison, a baseline build needs to be determined for the PR. This is typically based on the target branch for the PR. For example, if a pull request was targeting `main`, we would consider the baseline to be the latest successful `main` branch build.

### Downloading artifacts from baseline build

Once the baseline build is identified, we download the build artifacts corresponding to the `Code Coverage Report_{Build_Number}` artifact name for this build. We unzip the files and extract the coverage metrics out of the code coverage artifact using the helper `getCoverageMetricsFromArtifact`. Currently, we track `lineCoverage` and `branchCoverage` as our metrics for reporting and
use both `lineCoverage` and `branchCoverage` for success criteria. The metrics is in percentages from 0..100. The final structure of the extracted metrics looks like the following:

```typescript
/**
 * The type for the coverage report, containing the line coverage and branch coverage(in percentage) for each package
 */
export interface CoverageMetric {
	lineCoverage: number;
	branchCoverage: number;
}
```

### Generating the coverage metrics on PR build

As mentioned earlier, the PR build also uploads coverage metrics as artifacts that can be used to run coverage analysis against a baseline build. To help with this, we use the `getCoverageMetricsFromArtifact` helper function to extract code coverage metrics of format `CoverageMetric` that contains code coverage metrics corresponding to the PR for each package.

### Comparing code coverage reports

Once we have the coverage metrics for the baseline and PR build, we use the `compareCodeCoverage` utility function that returns an array of coverage comparisons for the list of packages passed into it. The array returned contains objects of type `CodeCoverageComparison`. We ignore some packages for comparing code coverage such as definition packages and packages which are not inside `packages` folder in the repo. The logic is in the `compareCodeCoverage` function.

```typescript
/**
 * Type for the code coverage report generated by comparing the baseline and pr code coverage
 */
export interface CodeCoverageComparison {
	/**
	 * Path of the package
	 */
	packagePath: string;
	/**
	 * Line coverage in baseline build (as a percent)
	 */
	lineCoverageInBaseline: number;
	/**
	 * Line coverage in pr build (as a percent)
	 */
	lineCoverageInPr: number;
	/**
	 * difference between line coverage in pr build and baseline build (percentage points)
	 */
	lineCoverageDiff: number;
	/**
	 * branch coverage in baseline build (as a percent)
	 */
	branchCoverageInBaseline: number;
	/**
	 * branch coverage in pr build (as a percent)
	 */
	branchCoverageInPr: number;
	/**
	 * difference between branch coverage in pr build and baseline build (percentage points)
	 */
	branchCoverageDiff: number;
	/**
	 * Flag to indicate if the package is new
	 */
	isNewPackage: boolean;
}
```

### Success Criteria

The code coverage PR checks will fail in the following cases:

- If the **line code coverage** or **branch code coverage** decreased by > 1%.
- If the code coverage(line and branch) for a newly added package is < 50%.

The enforcement code is in the function `isCodeCoverageCriteriaPassed`.
